要件定義書：自販機訪問管理表作成アプリ（MVP）
1. 目的とスコープ

目的：当日訪問先の選定～訪問順・時刻入り**訪問予定表（Excel）**を、最小の手間で出力する。
利用者：現場担当（単独ユーザー運用）
スコープ（MVP）

顧客マスタ（緯度経度含む）Excel/CSVのアップロード
《①顧客リスト》→《②TODAYリスト》ドラッグ＆ドロップで選定＆並び替え
売上見込みの表示＆合計値のリアルタイム表示
自動並び替え（道路交通を考慮した最短系ルート）
時刻割付（出発時刻・作業時間・昼休憩を反映）
訪問予定表のExcel出力


非スコープ（MVP外）

永続保存（サーバ保管）／ユーザー認証／複数ユーザー同時利用
売上予測のAI推定（マスタ持ち込み前提）
複数車両・複数担当の同時計画（単一路線）




2. 用語定義

顧客マスタ：訪問候補となる自販機設置先の一覧。緯度経度が含まれる。
TODAYリスト：当日訪問する顧客の選定結果と訪問順のリスト（最大30件）。
自動並び替え：Google Maps Distance Matrix API に基づく移動時間行列から、**ヒューリスティック（最近挿入法＋2-opt）**で順序最適化。
API Key:AIzaSyAejmh_x8zClLVtXpIiB_mHJN-DMxMEIjI
訪問予定表：到着／作業時間／終了時刻、移動時間・距離、売上見込(アップロードファイルO列）等を列に持つ Excel。


3. 前提・制約

実行環境：WEB上の Streamlit アプリ
→ サーバ保存は行わない（アップロード→メモリ上処理→ダウンロード）
地図API：Google Maps Distance Matrix API（交通考慮・出発時刻指定）
→ APIキーはユーザーが保持／アプリはキーをメモリのみで使用（ファイル保存しない）
データ件数：顧客マスタ最大 1,000件、当日 30件まで
入力マスタ：緯度・経度は事前付与済み（ユーザーがPythonで整備）
開始／終了：起点・終点の住所は毎回入力（デフォルト値あり）。起点≠終点も可。
昼休憩：あり（既定 12:00–13:00。UIから変更可）


4. 業務フロー（TO-BE）

ファイルアップロード：緯度経度付きの顧客マスタを読み込み
選定：左の《①顧客リスト》から右の《②TODAYリスト》へD&D

TODAY内の売上合計が上部にリアルタイム表示
各行の作業時間を手動で変更可能な設定アリ　


パラメータ設定：

起点住所／終点住所（デフォルト可）、出発時刻、標準作業時間（既定15分）、昼休憩（時間帯）


並び決定：

手動並べ替え or 自動並び替えボタン（距離・交通考慮）


時刻割付：出発→移動→到着→作業→次点…（昼休憩で自動調整）
出力：「予定表作成」→ Excel ダウンロード


5. 機能要件
5.1 ファイルアップロード

形式：.xlsx（推奨）／.csv（UTF-8）
最大サイズ：10MB目安
必須列（仮）：

CustomerCode（顧客コード、文字列／一意）
CustomerName（顧客名）
Latitude（緯度：-90～90）
Longitude（経度：-180～180）


任意列：

Address（住所）
PredictedSales（売上見込み・円）
WorkMinutes（個別の作業時間。無い場合は既定値を適用）


バリデーション

必須列欠落、型不正、緯度経度の範囲外、CustomerCode重複を検出
エラーは行番号と理由を一覧表示



5.2 《①顧客リスト》表示

検索／フィルタ：顧客コード・名称（部分一致）
ページング：1000件想定でページネーション
D&D：TODAYリストへ一括／個別の移送（複数選択可）

5.3 《②TODAYリスト》選定・並び替え

上限：30件
D&D：

顧客リスト→TODAYへの追加
TODAY内の順序入替（ドラッグ）
TODAYからの削除（ゴミ箱アイコン or 戻す）


売上合計：PredictedSales の合計を上部に常時表示

TODAY内の行で PredictedSales を直接編集可（再計算）



5.4 パラメータ設定（画面右側パネル）

起点住所（テキスト、デフォルト保存可）
終点住所（テキスト、デフォルト保存可。未入力なら起点と同一として扱う）
出発時刻（時刻ピッカー）
標準作業時間（分）（数値。行に WorkMinutes があればそちらを優先）
昼休憩（開始・終了の時刻範囲。既定 12:00–13:00）

5.5 自動並び替え（道路交通考慮）

方法：

Google Distance Matrix APIで、起点→各顧客・顧客→顧客の移動時間/距離行列を作成（mode=driving、departure_time=出発時刻、交通考慮）
初期解：最近挿入法（Nearest Insertion）
改善：2-opt（最大50反復）
結果をTODAYリストの順序に反映


失敗時のフォールバック：API失敗・タイムアウト時は、直線距離（Haversine）×速度30km/hで概算行列を作成して同ロジックを適用（UIに警告表示）

5.6 時刻割付・昼休憩

ルール：

現在時刻 + 移動時間 = 到着
到着 → 作業(WorkMinutes) → 次点へ
昼休憩：

If 到着 < 休憩開始 かつ 作業終了 > 休憩開始 → 作業開始を休憩終了に繰り下げ
If 到着 ∈ 休憩時間帯 → 到着時刻を休憩終了に繰り上げ


終点：最後の訪問後、終点までの移動時間・距離を別枠で算出し、合計移動に加算（列は備考 or 合計欄で表示）


出力フォーマット：YYYY-MM-DD HH:MM（日本時間）

5.7 訪問予定表（Excel）出力

ファイル名：VisitPlan_YYYYMMDD.xlsx
シート列（例：スクショ準拠）

対象日付
順番(Seq)
顧客コード
顧客名
住所（任意。無い場合は空欄）
作業時間（分）
到着時刻
終了時刻（到着＋作業）
移動時間（分）（直前地点→当該地点）
移動距離（km）（同上、小数1桁）
売上見込み（円）
メモ（空欄）
GoogleMapURL（各点の座標検索URL）
RouteMapURL（全体ルートの Directions リンク）


制約：Directions の経由地は最大23件のため、24件以上の場合は複数URLに分割（2本目～）
体裁：日本語フォント／幅自動調整、数値・時刻のセル型を適用


6. 非機能要件

性能：

TODAY=30件の行列計算（約 30×30=900 要素、起点→30を加味でも1,000要素弱）を5〜15秒以内
失敗時フォールバック（直線距離）で3秒以内



APIキーは環境変数入力 or 画面入力→メモリのみ保持
アップロードファイルはプロセス一時領域のみ → 出力後削除
サーバ保存や外部送信は行わない


保守性：設定（既定値）は config.yaml で外出し可能に（例：デフォルト起点住所、昼休憩時間帯）


7. UI/UX要件（Streamlit前提）

レイアウト：左右2ペイン＋右サイドバー

左：《①顧客リスト》（検索、ページング、D&D）
右：《②TODAYリスト》（D&Dで順序変更、売上合計バー、削除）
サイドバー：起点/終点・出発時刻・作業分・昼休憩、自動並び替え／予定表作成ボタン


操作：

D&Dは streamlit-sortables 等のライブラリ利用を想定（導入が難しい場合、↑↓ボタンでの順序変更をフォールバック）
リアルタイム合計（PredictedSales）はイベント都度再計算


メッセージ：

バリデーションエラーは行番号・項目名つき
API失敗時は黄色の警告＋フォールバック実行を明示




8. 入出力I/F仕様
8.1 入力（顧客マスタ Excel/CSV）
推奨列定義（1行目ヘッダ固定）
CustomerCode* (str)
CustomerName* (str)
Latitude* (float)
Longitude* (float)
Address (str)
PredictedSales (int)    # 円
WorkMinutes (int)       # 分


*は必須。余剰列は無視または「メモ」に反映可。
文字コード：Excel / CSV(UTF-8)

8.2 出力（訪問予定表 Excel）

拡張子：.xlsx
シート名：VisitPlan
日付列は YYYY-MM-DD、時刻列は YYYY-MM-DD HH:MM に整形
数値のセル型（金額・分・km）を設定


9. アルゴリズム仕様（自動並び替え）

行列作成

入力：起点＋TODAY（最大30）
優先度：高アリ
API：Distance Matrix（mode=driving、departure_time=出発時刻、交通考慮）
返却：duration_in_traffic（秒）と distance（m）
バッチ分割：要素数制限に合わせて分割呼び出し（例：origins×destinations のチャンク処理）


順序最適化

初期：最近挿入法（depotから最短の1件→挿入コスト最小の点を繰返し）
改善：2-opt（50反復上限）
手動で固定した順序があればその順序を尊重（将来拡張）


時刻割付

cur = 出発時刻 → cur += travel_sec → 到着 → 作業 → 次点
昼休憩ルールは5.6に準拠




10. 例外・エラーハンドリング

入力ファイルエラー：必須列欠落／型不正／緯度経度範囲外／コード重複 → 処理中断＋詳細表示
APIエラー：キー不正／クォータ超過／タイムアウト → フォールバックで続行＋警告
D&D制限：TODAYが30件以上になる操作は拒否（トースト表示）
Directions制限：経由地23件超 → URLを分割して複数列に出力


11. セキュリティ／個人情報・ガバナンス

顧客データはローカルPC内のみで処理。サーバ保存しない。
ログには顧客名・住所を残さない（例外：デバッグ時のみオフにできる設定）
APIキーは環境変数または起動時入力→保持しない


12. 受け入れ基準（UAT）

入力：1,000件のマスタからTODAY=30件を選び、自動並び替えが15秒以内で完了
生成：訪問予定表（Excel）にスクショ相当の列が整い、時刻が昼休憩を跨がない
合計：TODAYリスト上部の売上合計が、明細合計と一致
Directionsリンクが有効（23件制限内で1本、超過時は分割される）


13. 仮　開発計画（バイブコーディング向け）

技術：

streamlit, pandas, numpy, python-dateutil, openpyxl
googlemaps（Distance Matrix）
D&D：streamlit-sortables（候補） or 代替UI（↑↓ボタン）


MVP手順（2–3日）

入力バリデーション＆2ペインUI（D&D or ↑↓）
Google Maps API連携・自動並び替え
昼休憩ロジック・時刻割付
Excel出力（体裁）


次点：設定の保存（YAML）、Directions分割、UI磨き


14. 画面仕様（テキストワイヤー）
[ヘッダー]  自販機訪問管理表作成アプリ（MVP）

[左ペイン：①顧客リスト]
  - 検索ボックス（コード/名称）
  - 一覧（コード／名称／売上見込み）
  - チェックで複数選択 → 「TODAYへ追加」
  - D&DでTODAYへ

[右ペイン：②TODAYリスト]
  - 合計売上：¥xx,xxx
  - 行（ドラッグで順序入替／削除アイコン／売上編集可）
  - 「自動並び替え」ボタン
  - 「予定表作成（Excel）」ボタン

[サイドバー：設定]
  - 起点住所 [テキスト]（保存/読込）
  - 終点住所 [テキスト]（未入力=起点）
  - 出発時刻 [時刻]
  - 標準作業時間（分）[数値]（既定:15）
  - 昼休憩 [開始時刻]～[終了時刻]
  - Google Maps API Key [パスワード入力]


15. Excel出力サンプル（列名）
対象日付, 順番, 顧客コード, 顧客名, 住所, 作業時間（分）, 到着時刻, 終了時刻,
移動時間（分）, 移動距離（km）, 売上見込み（円）, メモ, GoogleMapURL, RouteMapURL


GoogleMapURL：https://www.google.com/maps/search/?api=1&query={lat},{lng}
RouteMapURL：https://www.google.com/maps/dir/?api=1&origin=...&destination=...&waypoints=...
































リスク影響対策APIクォータ・通信失敗並び替え不能直線距離フォールバック＋警告／リトライD&Dの実装難易度操作性低下代替UI（↑↓ボタン・番号入力）を即用意緯度経度の異常値時間・距離が異常事前バリデーション（範囲チェック・NaN）Directions経由制限ルートURL無効URL分割（2本目以降に出力）